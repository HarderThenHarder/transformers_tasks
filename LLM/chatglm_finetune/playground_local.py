# !/usr/bin/env python3
"""
==== No Bugs in code, just some Random Unexpected FEATURES ====
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”â”‚
â”‚â”‚Escâ”‚!1 â”‚@2 â”‚#3 â”‚$4 â”‚%5 â”‚^6 â”‚&7 â”‚*8 â”‚(9 â”‚)0 â”‚_- â”‚+= â”‚|\ â”‚`~ â”‚â”‚
â”‚â”œâ”€â”€â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”¤â”‚
â”‚â”‚ Tab â”‚ Q â”‚ W â”‚ E â”‚ R â”‚ T â”‚ Y â”‚ U â”‚ I â”‚ O â”‚ P â”‚{[ â”‚}] â”‚ BS  â”‚â”‚
â”‚â”œâ”€â”€â”€â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”¤â”‚
â”‚â”‚ Ctrl â”‚ A â”‚ S â”‚ D â”‚ F â”‚ G â”‚ H â”‚ J â”‚ K â”‚ L â”‚: ;â”‚" 'â”‚ Enter  â”‚â”‚
â”‚â”œâ”€â”€â”€â”€â”€â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”¬â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”¤â”‚
â”‚â”‚ Shift  â”‚ Z â”‚ X â”‚ C â”‚ V â”‚ B â”‚ N â”‚ M â”‚< ,â”‚> .â”‚? /â”‚Shift â”‚Fn â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”¬â”€â”€â”´â”¬â”€â”€â”´â”€â”€â”¬â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”¬â”´â”€â”€â”€â”´â”¬â”€â”€â”´â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜â”‚
â”‚      â”‚Fn â”‚ Alt â”‚         Space         â”‚ Alt â”‚Winâ”‚   HHKB   â”‚
â”‚      â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

webç«¯æµ‹è¯•LLMæ•ˆæœã€‚

Author: pankeyu
Date: 2023/03/17
"""
import os
import re
import time
import json
import datetime

import torch
import streamlit as st
import pandas as pd

from transformers import AutoTokenizer, AutoModel

torch.set_default_tensor_type(torch.cuda.HalfTensor)


st.set_page_config(
    page_title="LLM Playground",
    layout="wide"
)


device = 'cuda:0'
max_new_tokens = 300
model_path = "checkpoints/model_1000"

LOG_PATH = 'log'
DATASET_PATH = 'data'

LOG_FILE = 'web_log.log'
FEEDBACK_FILE = 'human_feedback.log'
DATASET_FILE = 'dataset.jsonl'


if not os.path.exists(DATASET_PATH):
    os.makedirs(DATASET_PATH)


if not os.path.exists(LOG_PATH):
    os.makedirs(LOG_PATH)

if not os.path.exists(os.path.join(DATASET_PATH, DATASET_FILE)):
    with open(os.path.join(DATASET_PATH, DATASET_FILE), 'w', encoding='utf8') as f:
        print('æ ‡æ³¨æ•°æ®é›†å·²åˆ›å»ºã€‚')


if 'model_out' not in st.session_state:
    st.session_state['model_out'] = ''
    st.session_state['used_time'] = 0.0


if 'model' not in st.session_state:
    with st.spinner('Loading Model...'):
        tokenizer = AutoTokenizer.from_pretrained(
            model_path, 
            trust_remote_code=True
        )
        model = AutoModel.from_pretrained(
            model_path,
            trust_remote_code=True
        ).half().to(device)
        st.session_state['model'] = model
        st.session_state['tokenizer'] = tokenizer


def start_evaluate_page():
    """
    æ¨¡å‹æµ‹è¯•é¡µé¢ã€‚
    """
    c1, c2 = st.columns([5, 5])
    with c1:
        with st.expander('âš™ï¸ Instruct è®¾å®šï¼ˆInstruct Settingï¼‰', expanded=True):
                instruct = st.text_area(
                    f'Instruct',
                    value='ä½ ç°åœ¨æ˜¯ä¸€ä¸ªå¾ˆå‰å®³çš„é˜…è¯»ç†è§£å™¨ï¼Œä¸¥æ ¼æŒ‰ç…§äººç±»æŒ‡ä»¤è¿›è¡Œå›ç­”ã€‚',
                    height=250
                )
    
    with c2:
        with st.expander('ğŸ’¬ å¯¹è¯è¾“å…¥æ¡†', expanded=True):
            current_input = st.text_area(
                'å½“å‰ç”¨æˆ·è¾“å…¥',
                value='å¸®æˆ‘æå–å‡ºä¸‹é¢å¥å­ä¸­æ‰€æœ‰çš„SPOï¼Œå¹¶è¾“å‡ºä¸ºjsonï¼Œä¸è¦åšå¤šä½™çš„å›å¤ï¼š\n\nã€Šç…çŠæ¦œã€‹æ˜¯ç”±å±±ä¸œå½±è§†ä¼ åª’é›†å›¢ã€å±±ä¸œå½±è§†åˆ¶ä½œæœ‰é™å…¬å¸ã€åŒ—äº¬å„’æ„æ¬£æ¬£å½±ä¸šæŠ•èµ„æœ‰é™å…¬å¸ã€åŒ—äº¬å’Œé¢‚å¤©åœ°å½±è§†æ–‡åŒ–æœ‰é™å…¬å¸ã€åŒ—äº¬åœ£åŸºå½±ä¸šæœ‰é™å…¬å¸ã€ä¸œé˜³æ­£åˆé˜³å…‰å½±è§†æœ‰é™å…¬å¸è”åˆå‡ºå“ï¼Œç”±å­”ç¬™ã€æé›ªæ‰§å¯¼ï¼Œèƒ¡æ­Œã€åˆ˜æ¶›ã€ç‹å‡¯ã€é»„ç»´å¾·ã€é™ˆé¾™ã€å´ç£Šã€é«˜é‘«ç­‰ä¸»æ¼”çš„å¤è£…å‰§ã€‚',
                height=200
            )
            bt = st.button('Generate')
        if bt:
            start = time.time()
            with st.spinner('ç”Ÿæˆä¸­...'):
                with torch.no_grad():
                    input_text = f"Instruction: {instruct}\n"
                    input_text += f"Input: {current_input}\n"
                    input_text += f"Answer:"
                    batch = st.session_state['tokenizer'](input_text, return_tensors="pt")
                    out = st.session_state['model'].generate(
                        input_ids=batch["input_ids"].to(device),
                        max_new_tokens=max_new_tokens,
                        temperature=0
                    )
                    out_text = st.session_state['tokenizer'].decode(out[0])
                    answer = out_text.split('Answer: ')[-1]
                    used_time = round(time.time() - start, 2)

                st.session_state['model_out'] = answer
                st.session_state['used_time'] = used_time

                with open(os.path.join(LOG_PATH, LOG_FILE), 'a', encoding='utf8') as f:
                    log_dict = {
                        'time': datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                        'used_seconds': used_time,
                        'instruct': instruct,
                        'input': current_input,
                        'model_output': st.session_state['model_out']
                    }
                    f.write(f'{json.dumps(log_dict, ensure_ascii=False)}\n')

    if st.session_state['model_out']:

        c1, c2 = st.columns([5, 5])

        with c2:
            with st.expander(f"ğŸ¤– å½“å‰æ¨¡å‹è¾“å‡ºï¼ˆ{st.session_state['used_time']}sï¼‰", expanded=True):
                answer = st.session_state['model_out']

                if len(answer) < 200:
                    height = 100
                elif len(answer) < 500:
                    height = 200
                else:
                    height = 300

                st.text_area(
                    '', 
                    value=f'{answer}',
                    height=height
                )

                human_feedback = st.radio(
                    "æ¨¡å‹ç”Ÿæˆç»“æœæ˜¯å¦æ­£ç¡® ğŸ‘‡",
                    ["ğŸ¤“ ä¸åé¦ˆ", "ğŸ˜Š æ­£ç¡®", "ğŸ˜¡ é”™è¯¯"],
                    key="visibility",
                    horizontal=True
                )

                if human_feedback in ["ğŸ˜¡ é”™è¯¯", "ğŸ˜Š æ­£ç¡®"]:
                    if human_feedback == "ğŸ˜¡ é”™è¯¯":
                        error_feedback = st.text_area(
                            '[error feedback]',
                            placeholder='æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œè¯·å¡«å†™é—®é¢˜çš„æ­£ç¡®ç­”æ¡ˆä»¥å¸®åŠ©æ¨¡å‹æ”¹è¿› ğŸ¥º'
                        )
                        current_feedback = {
                            'instruct': instruct,
                            'input': current_input,
                            'model_output': st.session_state['model_out'],
                            'human_feedback': error_feedback,
                            'is_error': True
                        }
                    else:
                        advice = st.text_area(
                            '[advice feedback]',
                            placeholder='è¯·è¾“å…¥æ‚¨çš„åé¦ˆ...'
                        )
                        current_feedback = {
                            'instruct': instruct,
                            'input': current_input,
                            'model_output': st.session_state['model_out'],
                            'human_feedback': advice,
                            'is_error': False
                        }
                    submit_button = st.button('æäº¤')
                    if submit_button:
                        with open(os.path.join(LOG_PATH, FEEDBACK_FILE), 'a', encoding='utf8') as f:
                            f.write(f'{json.dumps(current_feedback, ensure_ascii=False)}\n')
                        st.success('æ„Ÿè°¢æ‚¨çš„åé¦ˆ~', icon="âœ…")
    
        with c1:
            with st.expander(f'ğŸ’» json è§£æç»“æœ', expanded=True):
                st.markdown(answer)
                json_res = re.findall(r'```json(.*)```', answer.replace('\n', ''))
                if len(json_res):
                    json_res = json_res[0]
                    try:
                        json_res = json.loads(json_res)
                        st.write(json_res)
                    except:
                        pass


def read_dataset_file():
    """
    è¯»å–æœ¬åœ°æ ‡æ³¨çš„æ•°æ®é›†ã€‚
    """
    temp_dict = {}
    with open(os.path.join(DATASET_PATH, DATASET_FILE), 'r', encoding='utf8') as f:
        for line in f.readlines():
            line = json.loads(line)
            for key, value in line.items():
                if key not in temp_dict:
                    temp_dict[key] = []
                temp_dict[key].append(value)
    df = pd.DataFrame.from_dict(temp_dict)
    return df


def start_label_page():
    """
    æ•°æ®é›†æ ‡æ³¨é¡µé¢ã€‚
    """
    c1, c2 = st.columns([4, 6])

    with c1:
        with st.expander(f'ğŸ’» æ ‡æ³¨ç•Œé¢', expanded=True):
            instruct = st.text_area(
                    'Human Instruct',
                    value='ä½ ç°åœ¨æ˜¯ä¸€ä¸ªå¾ˆå‰å®³çš„é˜…è¯»ç†è§£å™¨ï¼Œä¸¥æ ¼æŒ‰ç…§äººç±»æŒ‡ä»¤è¿›è¡Œå›ç­”ã€‚'
                )
            inputs = st.text_area(
                    'Human Input',
                    placeholder='è¾“å…¥äººå·¥æ„é€ é—®é¢˜ï¼Œä¾‹å¦‚: å¸®æˆ‘æŠ½å–ä¸‹é¢å¥å­çš„SPOï¼Œç”¨jsonæ ¼å¼è¿”å›...'
                )
            answer = st.text_area(
                    'Human Output',
                    placeholder='è¾“å…¥äººå·¥æ„é€ ç­”æ¡ˆï¼Œä¾‹å¦‚:\n å¥½çš„ï¼Œä»¥ä¸‹æ˜¯æŠ½å–SPOçš„jsonä¿¡æ¯ï¼š\n```json\n{\n"subject": "å­™çº¢é›·", \n"predicate": "å¹´é¾„", \n"object": "52å²"\n}\n```',
                    height=500
                )
            save_button = st.button('Save')
            if save_button:
                with open(os.path.join(DATASET_PATH, DATASET_FILE), 'a', encoding='utf8') as f:
                    context = f'Instruction: {instruct}\nInput: {inputs}\nAnswer: '
                    current_sample = {
                        'context': context,
                        'target': answer
                    }
                    f.write(json.dumps(current_sample, ensure_ascii=False) + '\n')
                st.success('æ•°æ®å·²ä¿å­˜ï¼', icon="âœ…")
                st.session_state['dataset_df'] = read_dataset_file()
    
    with c2:
        if 'dataset_df' not in st.session_state:
            st.session_state['dataset_df'] = read_dataset_file()
        
        with st.expander(f"ğŸ“š æœ¬åœ°æ•°æ®é›†ï¼ˆå…± {len(st.session_state['dataset_df'])} æ¡ï¼‰", expanded=True):
            st.dataframe(st.session_state['dataset_df'], height=820)

            refresh_button = st.button('åˆ·æ–°æ•°æ®é›†')
            if refresh_button:
                st.session_state['dataset_df'] = read_dataset_file()


def main():
    """
    ä¸»å‡½æ•°æµç¨‹ã€‚
    """
    logo = '[![Typing SVG](https://readme-typing-svg.demolab.com?font=Fira+Code&duration=500&pause=500&color=00E455&center=true&vCenter=true&multiline=true&repeat=false&width=700&height=50&lines=LLM%EF%BC%88Large+Language+Model%EF%BC%89Playground+-+Enjoy++(%EF%BC%BE%EF%BC%B5%EF%BC%BE)%E3%83%8E)](https://github.com/HarderThenHarder/transformers_tasks)'
    st.markdown(logo)

    evaluate_page, label_page = st.tabs(['evaluate_page', 'label_page'])
    
    with evaluate_page:
        start_evaluate_page()

    with label_page:
        start_label_page()


if __name__ == '__main__':
    main()